<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Registro de Contacto - Padres y Tutores</title>
<link rel="icon" type="image/png" href="./logo.png">
<style>
* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
min-height: 100vh;
padding: 20px;
display: flex;
align-items: center;
justify-content: center;
}

.container {
background: white;
border-radius: 20px;
box-shadow: 0 20px 60px rgba(0,0,0,0.3);
max-width: 700px;
width: 100%;
overflow: hidden;
}

.header {
background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
color: white;
padding: 30px;
text-align: center;
}

.header h1 {
font-size: 2em;
margin-bottom: 10px;
}

.header p {
color: #4a9eff;
font-size: 1.1em;
}

.content {
padding: 40px;
}

.alert {
padding: 15px 20px;
border-radius: 10px;
margin-bottom: 25px;
display: none;
animation: slideIn 0.3s;
}

@keyframes slideIn {
from {
opacity: 0;
transform: translateY(-10px);
}
to {
opacity: 1;
transform: translateY(0);
}
}

.alert-success {
background: #d1fae5;
color: #065f46;
border-left: 4px solid #10b981;
}

.alert-error {
background: #fee2e2;
color: #991b1b;
border-left: 4px solid #dc2626;
}

.alert-info {
background: #dbeafe;
color: #1e40af;
border-left: 4px solid #3b82f6;
}

.form-group {
margin-bottom: 25px;
}

.form-group label {
display: block;
margin-bottom: 8px;
color: #374151;
font-weight: 600;
font-size: 0.95em;
}

.required {
color: #dc2626;
}

.form-group input,
.form-group select,
.form-group textarea {
width: 100%;
padding: 12px 15px;
border: 2px solid #e5e7eb;
border-radius: 10px;
font-size: 1em;
transition: all 0.3s;
font-family: inherit;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
outline: none;
border-color: #2a5298;
box-shadow: 0 0 0 3px rgba(42, 82, 152, 0.1);
}

.form-group textarea {
min-height: 100px;
resize: vertical;
}

/* Autocompletado */
.autocomplete-container {
position: relative;
}

.suggestions {
position: absolute;
top: 100%;
left: 0;
right: 0;
background: white;
border: 2px solid #2a5298;
border-top: none;
border-radius: 0 0 10px 10px;
max-height: 200px;
overflow-y: auto;
z-index: 1000;
box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.suggestion-item {
padding: 12px 15px;
cursor: pointer;
transition: background 0.2s;
}

.suggestion-item:hover {
background: #dbeafe;
}

.suggestion-item strong {
color: #1e3c72;
}

.btn {
width: 100%;
padding: 15px;
background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
color: white;
border: none;
border-radius: 10px;
font-size: 1.1em;
font-weight: 600;
cursor: pointer;
transition: all 0.3s;
box-shadow: 0 4px 6px rgba(30, 60, 114, 0.3);
}

.btn:hover {
transform: translateY(-2px);
box-shadow: 0 6px 12px rgba(30, 60, 114, 0.4);
}

.btn:active {
transform: translateY(0);
}

.btn:disabled {
background: #9ca3af;
cursor: not-allowed;
transform: none;
}

.info-box {
background: #d1fae5;
border: 2px solid #10b981;
border-radius: 10px;
padding: 20px;
margin-bottom: 25px;
}

.info-box h3 {
color: #065f46;
margin-bottom: 10px;
}

.info-box ul {
list-style: none;
padding-left: 0;
}

.info-box li {
padding: 5px 0;
color: #374151;
}

.info-box li:before {
content: "‚úì ";
color: #10b981;
font-weight: bold;
margin-right: 8px;
}

.loading {
text-align: center;
padding: 20px;
color: #6b7280;
}

.spinner {
border: 3px solid #f3f4f6;
border-top: 3px solid #2a5298;
border-radius: 50%;
width: 40px;
height: 40px;
animation: spin 1s linear infinite;
margin: 0 auto 15px;
}

@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}

@media (max-width: 600px) {
body {
padding: 10px;
}

.header h1 {
font-size: 1.5em;
}

.content {
padding: 25px;
}
}
</style>
</head>
<body>

<div class="container">
<div class="header">
<h1>üì± Registro de Contacto</h1>
<p>Padres y Tutores - CENSA</p>
</div>

<div class="content">
<div class="info-box">
<h3>üëã Bienvenido/a</h3>
<ul>
<li>Escriba el nombre de su hijo/a y selecci√≥nelo de la lista</li>
<li>Complete los datos de contacto disponibles</li>
<li>Clic en Registrar Contacto</li>
</ul>
</div>

<div id="alert" class="alert"></div>
<div id="loading" class="loading" style="display:none;">
<div class="spinner"></div>
<p>Cargando estudiantes...</p>
</div>

<form id="formContacto">
<div class="form-group autocomplete-container">
<label for="estudiante">Nombre del Estudiante</label>
<input 
type="text" 
id="estudiante" 
placeholder="Escriba el nombre del estudiante..."
autocomplete="off"
>
<div id="suggestions" class="suggestions" style="display:none;"></div>
<input type="hidden" id="cursoHidden">
</div>

<div class="form-group">
<label for="nombrePadre">Nombre del Padre</label>
<input 
type="text" 
id="nombrePadre" 
placeholder="Nombre completo del padre"
>
</div>

<div class="form-group">
<label for="contactoPadre">Contacto Padre</label>
<input 
type="tel" 
id="contactoPadre" 
placeholder="Tel√©fono del padre"
>
</div>

<div class="form-group">
<label for="nombreMadre">Nombre de la Madre</label>
<input 
type="text" 
id="nombreMadre" 
placeholder="Nombre completo de la madre"
>
</div>

<div class="form-group">
<label for="contactoMadre">Contacto Madre</label>
<input 
type="tel" 
id="contactoMadre" 
placeholder="Tel√©fono de la madre"
>
</div>

<div class="form-group">
<label for="contactoEmergencia">Contacto Emergencia</label>
<input 
type="tel" 
id="contactoEmergencia" 
placeholder="N√∫mero de emergencia"
>
</div>

<button type="submit" class="btn" id="btnSubmit">
‚úÖ Registrar Contacto
</button>
</form>
</div>
</div>

<script>
// ==========================================
// CONFIGURACI√ìN
// ==========================================

const CONFIG = {
urlContactos: 'https://script.google.com/macros/s/AKfycbyE6Lh8vSQfW1twVYUMu4YMdHqzXdCeNDi8mYRHA6GXm7b6kNw91v2nkDp90FePXamg/exec',
urlEstudiantes: 'https://script.google.com/macros/s/AKfycby-ceKgHZzTxQzcVcNiOWaN5aNDoqtIlihVcOZAp0_5hIVcv115GKHtfdjFPq43ttCEuA/exec',
urlAppsScript: 'https://script.google.com/macros/s/AKfycbyQ7veYDEtfslxTrulAYaXQvX0pgBhAhL0n5JmBgyQAeJUnaUzjZM-l4hRfiJ4GoBdp/exec'
};

// Array de estudiantes
let estudiantes = [];

// Array de contactos existentes
let contactosExistentes = [];

// ==========================================
// CARGA DE ESTUDIANTES
// ==========================================

async function cargarEstudiantes() {
// Obtener referencia al input de estudiante
const inputEstudiante = document.getElementById('estudiante');

// Mostrar indicador de carga en el input
inputEstudiante.placeholder = '‚è≥ Cargando estudiantes...';
inputEstudiante.disabled = true;

try {
const response = await fetch(CONFIG.urlEstudiantes);
const data = await response.json();

if (data && data.length > 0) {
estudiantes = data;
inputEstudiante.placeholder = 'Escriba el nombre del estudiante...';
inputEstudiante.disabled = false;
console.log(`‚úÖ ${estudiantes.length} estudiantes cargados`);
} else {
throw new Error('No se pudieron cargar los estudiantes');
}
} catch (error) {
console.error('Error al cargar estudiantes:', error);
inputEstudiante.placeholder = '‚ùå Error al cargar estudiantes';
inputEstudiante.disabled = true;
mostrarAlerta('No se pudieron cargar los estudiantes. Por favor, recargue la p√°gina.', 'error');
}
}

// ==========================================
// CARGA DE CONTACTOS EXISTENTES
// ==========================================

async function cargarContactosExistentes() {
try {
const response = await fetch(CONFIG.urlContactos);
const data = await response.json();

if (data && Array.isArray(data)) {
contactosExistentes = data;
console.log(`‚úÖ ${contactosExistentes.length} contactos existentes cargados`);
}
} catch (error) {
console.error('‚ö†Ô∏è No se pudieron cargar contactos existentes:', error);
// No mostramos error al usuario, solo lo registramos
}
}

// ==========================================
// AUTOCOMPLETADO
// ==========================================

const inputEstudiante = document.getElementById('estudiante');
const suggestionsDiv = document.getElementById('suggestions');
const cursoHidden = document.getElementById('cursoHidden');

inputEstudiante.addEventListener('input', function() {
const query = this.value.toLowerCase().trim();

if (query.length < 2) {
suggestionsDiv.style.display = 'none';
return;
}

const filtrados = estudiantes.filter(est => {
const nombre = (est['Nombre Completo'] || est.nombre || '').toLowerCase();
return nombre.includes(query);
});

if (filtrados.length === 0) {
suggestionsDiv.style.display = 'none';
return;
}

suggestionsDiv.innerHTML = filtrados.slice(0, 8).map(est => {
const nombre = est['Nombre Completo'] || est.nombre || '';
const curso = est['Curso'] || est.curso || '';
return `
<div class="suggestion-item" onclick="seleccionarEstudiante('${nombre}', '${curso}')">
<strong>${nombre}</strong><br>
<small style="color:#6b7280;">${curso}</small>
</div>
`;
}).join('');

suggestionsDiv.style.display = 'block';
});

// Cerrar sugerencias al hacer click fuera
document.addEventListener('click', function(e) {
if (!e.target.closest('.autocomplete-container')) {
suggestionsDiv.style.display = 'none';
}
});

function seleccionarEstudiante(nombre, curso) {
inputEstudiante.value = nombre;
cursoHidden.value = curso;
suggestionsDiv.style.display = 'none';
}

// ==========================================
// ENV√çO DEL FORMULARIO
// ==========================================

document.getElementById('formContacto').addEventListener('submit', async function(e) {
e.preventDefault();

const btnSubmit = document.getElementById('btnSubmit');
const nombreEstudiante = document.getElementById('estudiante').value.trim();

// Validar que se haya seleccionado un estudiante
if (!nombreEstudiante) {
mostrarAlerta('‚ö†Ô∏è Por favor, seleccione un estudiante de la lista.', 'error');
return;
}

// Verificar si el contacto ya existe
const contactoExistente = contactosExistentes.find(c => {
const nombreEnBD = (c['Nombre Estudiante'] || c.estudiante || '').trim().toLowerCase();
return nombreEnBD === nombreEstudiante.toLowerCase();
});

if (contactoExistente) {
mostrarAlerta('‚ÑπÔ∏è Este estudiante ya tiene un contacto registrado en el sistema. Si desea actualizar la informaci√≥n, por favor contacte a la administraci√≥n del colegio.', 'info');
return;
}

btnSubmit.disabled = true;
btnSubmit.textContent = '‚è≥ Registrando...';

try {
const contacto = {
'Nombre Estudiante': nombreEstudiante,
'Nombre Padre': document.getElementById('nombrePadre').value || '',
'Contacto Padre': document.getElementById('contactoPadre').value || '',
'Nombre Madre': document.getElementById('nombreMadre').value || '',
'Contacto Madre': document.getElementById('contactoMadre').value || '',
'Contacto Emergencia': document.getElementById('contactoEmergencia').value || ''
};

console.log('üì§ Enviando contacto a Google Sheets...');
console.log('üìã Datos:', contacto);

// Crear FormData
const formData = new FormData();
formData.append('accion', 'guardarContacto');
formData.append('datos', JSON.stringify(contacto));

// Enviar a Apps Script
const response = await fetch(CONFIG.urlAppsScript, {
method: 'POST',
body: formData,
redirect: 'follow'
});

console.log('‚úÖ Contacto enviado a Google Sheets');

// Peque√±a pausa para asegurar procesamiento
await new Promise(resolve => setTimeout(resolve, 1000));

// Agregar el nuevo contacto al array local para futuras validaciones
contactosExistentes.push(contacto);

mostrarAlerta('‚úÖ ¬°Contacto registrado exitosamente! Gracias por proporcionar su informaci√≥n.', 'success');

// Limpiar formulario
document.getElementById('formContacto').reset();
document.getElementById('cursoHidden').value = '';

// Scroll hacia arriba
window.scrollTo({ top: 0, behavior: 'smooth' });

} catch (error) {
console.error('‚ùå Error:', error);
mostrarAlerta('‚ùå Error al registrar el contacto. Por favor, intente nuevamente.', 'error');
}

btnSubmit.disabled = false;
btnSubmit.textContent = '‚úÖ Registrar Contacto';
});

// ==========================================
// FUNCIONES AUXILIARES
// ==========================================

function mostrarAlerta(mensaje, tipo = 'info') {
const alert = document.getElementById('alert');
alert.textContent = mensaje;
alert.className = 'alert alert-' + tipo;
alert.style.display = 'block';

setTimeout(() => {
alert.style.display = 'none';
}, 5000);
}

// ==========================================
// INICIALIZACI√ìN
// ==========================================

window.addEventListener('load', function() {
console.log('üöÄ P√°gina de registro de contactos cargada');
cargarEstudiantes();
cargarContactosExistentes();
});
</script>

</body>
</html>
