<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Registro de Incidencias - Maestros</title>
<style>
* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
min-height: 100vh;
padding: 20px;
display: flex;
align-items: center;
justify-content: center;
}

.container {
background: white;
border-radius: 20px;
box-shadow: 0 20px 60px rgba(0,0,0,0.3);
max-width: 800px;
width: 100%;
overflow: hidden;
}

.header {
background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
color: white;
padding: 30px;
text-align: center;
}

.header h1 {
font-size: 2em;
margin-bottom: 10px;
}

.header p {
color: #4a9eff;
font-size: 1.1em;
}

.content {
padding: 40px;
}

.alert {
padding: 15px 20px;
border-radius: 10px;
margin-bottom: 25px;
display: none;
animation: slideIn 0.3s;
}

@keyframes slideIn {
from {
opacity: 0;
transform: translateY(-10px);
}
to {
opacity: 1;
transform: translateY(0);
}
}

.alert-success {
background: #d1fae5;
color: #065f46;
border-left: 4px solid #10b981;
}

.alert-error {
background: #fee2e2;
color: #991b1b;
border-left: 4px solid #ef4444;
}

.form-group {
margin-bottom: 25px;
}

label {
display: block;
margin-bottom: 8px;
color: #1f2937;
font-weight: 600;
font-size: 0.95em;
}

input[type="datetime-local"],
input[type="text"],
select,
textarea {
width: 100%;
padding: 12px 15px;
border: 2px solid #e5e7eb;
border-radius: 10px;
font-size: 1em;
transition: all 0.3s;
font-family: inherit;
}

input:focus,
select:focus,
textarea:focus {
outline: none;
border-color: #2a5298;
box-shadow: 0 0 0 3px rgba(42, 82, 152, 0.1);
}

select:disabled {
background: #f3f4f6;
color: #9ca3af;
cursor: not-allowed;
}

textarea {
resize: vertical;
min-height: 120px;
}

.autocomplete-container {
position: relative;
}

.suggestions {
position: absolute;
top: 100%;
left: 0;
right: 0;
background: white;
border: 2px solid #e5e7eb;
border-top: none;
border-radius: 0 0 10px 10px;
max-height: 250px;
overflow-y: auto;
display: none;
z-index: 1000;
box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.suggestion-item {
padding: 12px 15px;
cursor: pointer;
transition: background 0.2s;
border-bottom: 1px solid #f3f4f6;
}

.suggestion-item:last-child {
border-bottom: none;
}

.suggestion-item:hover {
background: #f3f4f6;
}

.suggestion-name {
font-weight: 600;
color: #1f2937;
}

.suggestion-course {
font-size: 0.85em;
color: #6b7280;
margin-left: 8px;
}

.btn {
width: 100%;
padding: 15px;
background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
color: white;
border: none;
border-radius: 10px;
font-size: 1.1em;
font-weight: 600;
cursor: pointer;
transition: all 0.3s;
margin-top: 10px;
}

.btn:hover {
transform: translateY(-2px);
box-shadow: 0 10px 20px rgba(42, 82, 152, 0.3);
}

.btn:active {
transform: translateY(0);
}

.btn:disabled {
background: #9ca3af;
cursor: not-allowed;
transform: none;
}

.required {
color: #dc2626;
}

.form-row {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 20px;
}

@media (max-width: 768px) {
.form-row {
grid-template-columns: 1fr;
}

.content {
padding: 25px;
}

.header h1 {
font-size: 1.5em;
}
}

.loading {
display: inline-block;
width: 20px;
height: 20px;
border: 3px solid rgba(255,255,255,.3);
border-radius: 50%;
border-top-color: white;
animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
to { transform: rotate(360deg); }
}
</style>
</head>
<body>
<div class="container">
<div class="header">
<h1>üìã Registro de Incidencias</h1>
<p>Sistema de Gesti√≥n de Convivencia - CENSA</p>
</div>

<div class="content">
<!-- INSTRUCCIONES MEJORADAS -->
<div style="background:#f0fdf4;border-left:4px solid #059669;padding:15px 20px;margin-bottom:25px;border-radius:8px;">
<div style="display:flex;align-items:start;gap:12px;">
<div style="font-size:1.5em;color:#059669;">üí°</div>
<div style="flex:1;">
<strong style="color:#059669;display:block;margin-bottom:8px;">Instrucciones:</strong>
<ul style="margin:0;padding-left:20px;line-height:1.8;color:#065f46;">
<li>Complete todos los campos marcados con <span style="color:#dc2626;font-weight:bold;">*</span></li>
<li>Al escribir el <strong>nombre del estudiante</strong>, ver√° sugerencias autom√°ticas</li>
<li>Seleccione el nombre correcto y el <strong>curso se completar√° autom√°ticamente</strong></li>
</ul>
</div>
</div>
</div>

<div class="alert alert-success" id="alertSuccess">
‚úÖ <strong>¬°Incidencia registrada exitosamente!</strong>
</div>

<div class="alert alert-error" id="alertError">
‚ùå <strong>Error:</strong> <span id="errorMessage"></span>
</div>

<form id="formIncidencia">
<div class="form-group">
<label for="fechaIncidencia">Fecha y Hora <span class="required">*</span></label>
<input type="datetime-local" id="fechaIncidencia" required>
</div>

<div class="form-group autocomplete-container">
<label for="nombreEstudiante">Nombre del Estudiante <span class="required">*</span></label>
<input 
type="text" 
id="nombreEstudiante" 
placeholder="Escriba el nombre del estudiante..."
required
autocomplete="off"
>
<div class="suggestions" id="suggestions"></div>
</div>

<div class="form-group">
<label for="cursoIncidencia">Curso <span class="required">*</span></label>
<select id="cursoIncidencia" required>
<option value="">Seleccione un curso</option>
<option value="1roA">1roA</option>
<option value="1roB">1roB</option>
<option value="1roC">1roC</option>
<option value="2doA">2doA</option>
<option value="2doB">2doB</option>
<option value="2doC">2doC</option>
<option value="3roA">3roA</option>
<option value="3roB">3roB</option>
<option value="3roC">3roC</option>
<option value="4toA">4toA</option>
<option value="4toB">4toB</option>
<option value="4toC">4toC</option>
<option value="5toA">5toA</option>
<option value="5toB">5toB</option>
<option value="5toC">5toC</option>
<option value="6toA">6toA</option>
<option value="6toB">6toB</option>
<option value="6toC">6toC</option>
</select>
</div>

<div class="form-group">
<label for="tipoFalta">Tipo de Falta <span class="required">*</span></label>
<select id="tipoFalta" required>
<option value="">Seleccione el tipo</option>
<option value="Leve">Leve</option>
<option value="Grave">Grave</option>
<option value="Muy Grave">Muy Grave</option>
</select>
</div>

<div class="form-group">
<label for="docenteReporta">Docente que Reporta <span class="required">*</span></label>
<input 
type="text" 
id="docenteReporta" 
placeholder="Su nombre completo"
required
>
</div>

<div class="form-group">
<label for="descripcion">Descripci√≥n de la Incidencia <span class="required">*</span></label>
<textarea 
id="descripcion" 
placeholder="Describa detalladamente lo sucedido..."
required
></textarea>
</div>

<div class="form-group">
<label for="accionesDocente">Acciones Tomadas por el Docente <span class="required">*</span></label>
<textarea 
id="accionesDocente" 
placeholder="Describa las acciones que tom√≥ para manejar la situaci√≥n..."
></textarea>
</div>

<button type="submit" class="btn" id="btnSubmit">
Registrar Incidencia
</button>
</form>
</div>
</div>

<script>
// ==========================================
// CONFIGURACI√ìN (EN MEMORIA - NO localStorage)
// ==========================================

const CONFIG = {
urlIncidencias: 'https://script.google.com/macros/s/AKfycbwnCHIHNum-8uCHLbuE5NvwJeVmVMF6hCLWOAQQRUOwsU5GK_vpkrxifDFlMat1tP-z/exec',
urlEstudiantes: 'https://script.google.com/macros/s/AKfycby-ceKgHZzTxQzcVcNiOWaN5aNDoqtIlihVcOZAp0_5hIVcv115GKHtfdjFPq43ttCEuA/exec',
urlAppsScript: 'https://script.google.com/macros/s/AKfycbyQ7veYDEtfslxTrulAYaXQvX0pgBhAhL0n5JmBgyQAeJUnaUzjZM-l4hRfiJ4GoBdp/exec'
};

// Array de estudiantes
let estudiantes = [];

// ==========================================
// CARGA DE ESTUDIANTES
// ==========================================

async function cargarEstudiantes() {
try {
console.log('üîÑ Cargando estudiantes...');
const response = await fetch(CONFIG.urlEstudiantes);
const data = await response.json();

console.log('üì¶ Respuesta completa:', data);

// Verificar diferentes formatos de respuesta
if (data.values && data.values.length > 1) {
// Formato: {values: [[header], [row1], [row2]...]}
const headers = data.values[0];
estudiantes = data.values.slice(1).map(row => {
const obj = {};
headers.forEach((header, index) => {
obj[header] = row[index] || '';
});
return obj;
});
console.log(`‚úÖ ${estudiantes.length} estudiantes cargados (formato values)`);
} else if (Array.isArray(data) && data.length > 0) {
// Formato: [{nombre: "...", curso: "..."}, ...]
estudiantes = data;
console.log(`‚úÖ ${estudiantes.length} estudiantes cargados (formato array)`);
} else if (data.data && Array.isArray(data.data)) {
// Formato: {data: [{...}, {...}]}
estudiantes = data.data;
console.log(`‚úÖ ${estudiantes.length} estudiantes cargados (formato data)`);
} else {
console.warn('‚ö†Ô∏è Formato de respuesta no reconocido');
console.log('Estructura recibida:', Object.keys(data));
}

if (estudiantes.length > 0) {
console.log('üë§ Primer estudiante:', estudiantes[0]);
console.log('üîë Campos disponibles:', Object.keys(estudiantes[0]));
} else {
console.warn('‚ö†Ô∏è No se encontraron estudiantes en la respuesta');
}
} catch (error) {
console.error('‚ùå Error cargando estudiantes:', error);
}
}

// ==========================================
// AUTOCOMPLETADO DE ESTUDIANTES
// ==========================================

const inputEstudiante = document.getElementById('nombreEstudiante');
const suggestionsDiv = document.getElementById('suggestions');

inputEstudiante.addEventListener('input', function() {
const texto = this.value.toLowerCase().trim();

if (texto.length < 2) {
suggestionsDiv.style.display = 'none';
return;
}

console.log(`üîç Buscando: "${texto}"`);

const coincidencias = estudiantes.filter(e => {
// Intentar diferentes posibles nombres de campos
const nombre = (
e['Nombre Completo'] || 
e['nombre'] || 
e['Nombre'] || 
e['NOMBRE'] ||
e['nombre_completo'] ||
e['NombreCompleto'] ||
''
).toLowerCase();
return nombre.includes(texto);
}).slice(0, 15);

console.log(`üìã Coincidencias encontradas: ${coincidencias.length}`);

if (coincidencias.length === 0) {
suggestionsDiv.style.display = 'none';
return;
}

suggestionsDiv.innerHTML = coincidencias.map((e, index) => {
const nombre = e['Nombre Completo'] || e['nombre'] || e['Nombre'] || e['NOMBRE'] || e['nombre_completo'] || e['NombreCompleto'] || '';
const curso = e['Curso'] || e['curso'] || e['CURSO'] || '';
return `
<div class="suggestion-item" data-index="${index}">
<span class="suggestion-name">${nombre}</span>
<span class="suggestion-course">(${curso})</span>
</div>
`;
}).join('');

// Agregar event listeners a cada sugerencia
document.querySelectorAll('.suggestion-item').forEach((item, index) => {
item.addEventListener('click', function() {
const estudiante = coincidencias[index];
const nombre = estudiante['Nombre Completo'] || estudiante['nombre'] || estudiante['Nombre'] || estudiante['NOMBRE'] || estudiante['nombre_completo'] || estudiante['NombreCompleto'] || '';
const curso = estudiante['Curso'] || estudiante['curso'] || estudiante['CURSO'] || '';
seleccionarEstudiante(nombre, curso);
});
});

suggestionsDiv.style.display = 'block';
});

function seleccionarEstudiante(nombre, curso) {
inputEstudiante.value = nombre;
document.getElementById('cursoIncidencia').value = curso;
suggestionsDiv.style.display = 'none';
console.log(`‚úÖ Estudiante seleccionado: ${nombre} (${curso})`);
}

// Cerrar sugerencias al hacer clic fuera
document.addEventListener('click', function(e) {
if (!e.target.closest('.autocomplete-container')) {
suggestionsDiv.style.display = 'none';
}
});

// ==========================================
// ENV√çO DEL FORMULARIO
// ==========================================

document.getElementById('formIncidencia').addEventListener('submit', async function(e) {
e.preventDefault();

const btnSubmit = document.getElementById('btnSubmit');
const alertSuccess = document.getElementById('alertSuccess');
const alertError = document.getElementById('alertError');

// Ocultar alertas
alertSuccess.style.display = 'none';
alertError.style.display = 'none';

// Deshabilitar bot√≥n
btnSubmit.disabled = true;
btnSubmit.innerHTML = '<span class="loading"></span> Guardando...';

try {
// Obtener valores del formulario
const datos = {
'Fecha y Hora': document.getElementById('fechaIncidencia').value,
'Curso': document.getElementById('cursoIncidencia').value,
'Nombre Estudiante': document.getElementById('nombreEstudiante').value,
'Tipo de falta': document.getElementById('tipoFalta').value,
'Docente que Reporta': document.getElementById('docenteReporta').value,
'Descripci√≥n': document.getElementById('descripcion').value,
'Acciones del Docente': document.getElementById('accionesDocente').value
};

// Enviar a Google Sheets
await enviarAGoogleSheets(datos);

// Mostrar √©xito
alertSuccess.style.display = 'block';

// Limpiar formulario
this.reset();

// Restablecer fecha actual
const now = new Date();
now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
document.getElementById('fechaIncidencia').value = now.toISOString().slice(0, 16);

// Scroll al inicio
window.scrollTo({ top: 0, behavior: 'smooth' });

// Ocultar alerta despu√©s de 5 segundos
setTimeout(() => {
alertSuccess.style.display = 'none';
}, 5000);

} catch (error) {
console.error('Error:', error);
document.getElementById('errorMessage').textContent = error.message;
alertError.style.display = 'block';
window.scrollTo({ top: 0, behavior: 'smooth' });
} finally {
btnSubmit.disabled = false;
btnSubmit.innerHTML = 'Registrar Incidencia';
}
});

// ==========================================
// FUNCI√ìN PARA ENVIAR A GOOGLE SHEETS
// ==========================================

async function enviarAGoogleSheets(datos) {
try {
const response = await fetch(CONFIG.urlAppsScript, {
method: 'POST',
mode: 'no-cors',
headers: {
'Content-Type': 'application/json',
},
body: JSON.stringify(datos)
});

console.log('‚úÖ Datos enviados a Google Sheets');
console.log('üìã INCIDENCIA REGISTRADA:');
console.log(datos);
return true;
} catch (error) {
console.error('Error enviando a Apps Script:', error);
throw new Error('No se pudo conectar con Google Sheets');
}
}

// ==========================================
// INICIALIZACI√ìN
// ==========================================

window.addEventListener('DOMContentLoaded', () => {
// Establecer fecha y hora actual
const now = new Date();
now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
document.getElementById('fechaIncidencia').value = now.toISOString().slice(0, 16);

// Cargar estudiantes
cargarEstudiantes();

console.log('‚úÖ Sistema de incidencias para maestros cargado');
console.log('üìù Configuraci√≥n:', CONFIG);
});
</script>
</body>
</html>
