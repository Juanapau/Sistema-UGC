<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Registro de Incidencias - Maestros</title>

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
    font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
    background:linear-gradient(135deg,#1e3c72,#2a5298);
    min-height:100vh;
    display:flex;
    justify-content:center;
    align-items:center;
    padding:20px;
}
.container{
    background:#fff;
    border-radius:20px;
    max-width:800px;
    width:100%;
    box-shadow:0 20px 60px rgba(0,0,0,.3);
    overflow:hidden;
}
.header{
    background:#000;
    color:#fff;
    padding:30px;
    text-align:center;
}
.content{padding:40px}
label{font-weight:600;margin-bottom:6px;display:block}
input,select,textarea{
    width:100%;
    padding:12px;
    border-radius:10px;
    border:2px solid #e5e7eb;
    font-size:1em;
}
input:focus,select:focus,textarea:focus{
    outline:none;
    border-color:#2a5298;
}
textarea{min-height:120px}
.form-group{margin-bottom:25px}
.required{color:#dc2626}

.autocomplete-container{position:relative}
.suggestions{
    position:absolute;
    top:100%;
    left:0;
    right:0;
    background:#fff;
    border:2px solid #e5e7eb;
    border-top:none;
    max-height:250px;
    overflow-y:auto;
    display:none;
    z-index:1000;
}
.suggestion-item{
    padding:10px;
    cursor:pointer;
    border-bottom:1px solid #f3f4f6;
}
.suggestion-item:hover{background:#f3f4f6}
.suggestion-name{font-weight:600}
.suggestion-course{font-size:.85em;color:#6b7280;margin-left:6px}

button{
    width:100%;
    padding:15px;
    background:#2a5298;
    color:#fff;
    border:none;
    border-radius:10px;
    font-size:1.1em;
    font-weight:600;
    cursor:pointer;
}
button:disabled{background:#9ca3af}
.alert{display:none;margin-bottom:20px;padding:12px;border-radius:8px}
.alert-success{background:#d1fae5;color:#065f46}
.alert-error{background:#fee2e2;color:#991b1b}
</style>
</head>

<body>
<div class="container">
    <div class="header">
        <h1>ðŸ“‹ Registro de Incidencias</h1>
        <p>Sistema de GestiÃ³n de Convivencia - CENSA</p>
    </div>

<div class="content">

<div class="alert alert-success" id="alertSuccess">âœ… Incidencia registrada correctamente</div>
<div class="alert alert-error" id="alertError"><span id="errorMessage"></span></div>

<form id="formIncidencia">

<div class="form-group">
<label>Fecha y Hora <span class="required">*</span></label>
<input type="datetime-local" id="fechaIncidencia" required>
</div>

<div class="form-group autocomplete-container">
<label>Nombre del Estudiante <span class="required">*</span></label>
<input type="text" id="nombreEstudiante" autocomplete="off" placeholder="Escriba el nombre..." required>
<div class="suggestions" id="suggestions"></div>
</div>

<div class="form-group">
<label>Curso <span class="required">*</span></label>
<select id="cursoIncidencia" required>
<option value="">Seleccione</option>
<option>1roA</option><option>1roB</option><option>1roC</option>
<option>2doA</option><option>2doB</option><option>2doC</option>
<option>3roA</option><option>3roB</option><option>3roC</option>
<option>4toA</option><option>4toB</option><option>4toC</option>
<option>5toA</option><option>5toB</option><option>5toC</option>
<option>6toA</option><option>6toB</option><option>6toC</option>
</select>
</div>

<div class="form-group">
<label>Tipo de Falta <span class="required">*</span></label>
<select id="tipoFalta" required>
<option value="">Seleccione</option>
<option>Leve</option>
<option>Grave</option>
<option>Muy Grave</option>
</select>
</div>

<div class="form-group">
<label>Docente que Reporta <span class="required">*</span></label>
<input type="text" id="docenteReporta" required>
</div>

<div class="form-group">
<label>DescripciÃ³n <span class="required">*</span></label>
<textarea id="descripcion" required></textarea>
</div>

<div class="form-group">
<label>Acciones Tomadas</label>
<textarea id="accionesDocente"></textarea>
</div>

<button type="submit" id="btnSubmit">Registrar Incidencia</button>

</form>
</div>
</div>

<script>
// ================= URLS ORIGINALES =================
const URL_INCIDENCIAS = 'https://script.google.com/macros/s/AKfycbx7_pvGcRFlfDu6yoUHa0EN9oNz9d9XIolBksCI2opqhVBwkNNMoYHyt3-4iOTI26uT/exec';
const URL_ESTUDIANTES = 'https://script.google.com/macros/s/AKfycbyk1gUcU_cFSDbMz34WpEn1s81ctUIExmxzG062TZAx0KQhj5eOyQQVN2Rk8rLdMkicEA/exec';
const URL_APPS_SCRIPT = 'https://script.google.com/macros/s/AKfycbx2Hdz1rYL8GBn9PVG64sFOHC0wBfivmKFNwM4lmSWKzN6C7iKhTHRdxKMbwiowMnNx/exec';

let estudiantes = [];

// ================= CARGA DE ESTUDIANTES =================
async function cargarEstudiantes(){
    try{
        const res = await fetch(URL_ESTUDIANTES);
        const data = await res.json();

        if(Array.isArray(data)){
            estudiantes = data;
            console.log(`âœ… ${estudiantes.length} estudiantes cargados`);
            return;
        }

        if(data.values){
            const headers = data.values[0];
            estudiantes = data.values.slice(1).map(row=>{
                let obj={};
                headers.forEach((h,i)=>obj[h]=row[i]||'');
                return obj;
            });
            console.log(`âœ… ${estudiantes.length} estudiantes cargados`);
        }
    }catch(e){
        console.error('âŒ Error cargando estudiantes',e);
    }
}

// ================= AUTOCOMPLETE =================
const input = document.getElementById('nombreEstudiante');
const sug = document.getElementById('suggestions');

input.addEventListener('input',()=>{
    const txt = input.value.toLowerCase().trim();
    if(txt.length<2){sug.style.display='none';return;}

    const matches = estudiantes.filter(e=>{
        const nombre = (
            e['Nombre Completo']||
            e['Nombre']||
            e['Estudiante']||
            e.nombre||
            ''
        ).toLowerCase();
        return nombre.includes(txt);
    }).slice(0,15);

    if(!matches.length){sug.style.display='none';return;}

    sug.innerHTML = matches.map((e,i)=>{
        const n = e['Nombre Completo']||e['Nombre']||e['Estudiante']||e.nombre||'';
        const c = e['Curso']||e.curso||'';
        return `
        <div class="suggestion-item" data-i="${i}">
            <span class="suggestion-name">${n}</span>
            <span class="suggestion-course">(${c})</span>
        </div>`;
    }).join('');

    document.querySelectorAll('.suggestion-item').forEach(item=>{
        item.onclick=()=>{
            const e = matches[item.dataset.i];
            input.value = e['Nombre Completo']||e['Nombre']||e['Estudiante']||e.nombre||'';
            document.getElementById('cursoIncidencia').value = e['Curso']||e.curso||'';
            sug.style.display='none';
        };
    });

    sug.style.display='block';
});

document.addEventListener('click',e=>{
    if(!e.target.closest('.autocomplete-container')){
        sug.style.display='none';
    }
});

// ================= ENVÃO =================
document.getElementById('formIncidencia').onsubmit=async e=>{
    e.preventDefault();
    try{
        await fetch(URL_APPS_SCRIPT,{
            method:'POST',
            mode:'no-cors',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({
                fecha:fechaIncidencia.value,
                curso:cursoIncidencia.value,
                estudiante:nombreEstudiante.value,
                falta:tipoFalta.value,
                docente:docenteReporta.value,
                descripcion:descripcion.value,
                acciones:accionesDocente.value
            })
        });
        alertSuccess.style.display='block';
        e.target.reset();
    }catch(err){
        errorMessage.textContent='Error al guardar la incidencia';
        alertError.style.display='block';
    }
};

// ================= INIT =================
window.onload=()=>{
    const d=new Date();
    d.setMinutes(d.getMinutes()-d.getTimezoneOffset());
    fechaIncidencia.value=d.toISOString().slice(0,16);
    cargarEstudiantes();
};
</script>

</body>
</html>
