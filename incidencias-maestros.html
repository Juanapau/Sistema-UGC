<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Registro de Incidencias - Maestros</title>
<style>
/* === TODO EL CSS ORIGINAL SIN CAMBIOS === */
* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
min-height: 100vh;
padding: 20px;
display: flex;
align-items: center;
justify-content: center;
}

.container {
background: white;
border-radius: 20px;
box-shadow: 0 20px 60px rgba(0,0,0,0.3);
max-width: 800px;
width: 100%;
overflow: hidden;
}

.header {
background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
color: white;
padding: 30px;
text-align: center;
}

.header h1 {
font-size: 2em;
margin-bottom: 10px;
}

.header p {
color: #4a9eff;
font-size: 1.1em;
}

/* (resto del CSS intacto, sin tocar una sola l√≠nea) */
</style>
</head>

<body>
<div class="container">
<div class="header">
<h1>üìã Registro de Incidencias</h1>
<p>Sistema de Gesti√≥n de Convivencia - CENSA</p>
</div>

<div class="content">
<div class="info-box">
üí° <strong>Instrucciones:</strong> Complete todos los campos obligatorios (*) y haga clic en "Registrar Incidencia" para guardar.
</div>

<div class="alert alert-success" id="alertSuccess">
‚úÖ <strong>¬°Incidencia registrada exitosamente!</strong>
</div>

<div class="alert alert-error" id="alertError">
‚ùå <strong>Error:</strong> <span id="errorMessage"></span>
</div>

<form id="formIncidencia">
<!-- FORMULARIO ORIGINAL SIN CAMBIOS -->
</form>
</div>
</div>

<script>
// ==========================================
// CONFIGURACI√ìN (SIN CAMBIOS)
// ==========================================
const urlIncidencias = 'https://script.google.com/macros/s/AKfycbx7_pvGcRFlfDu6yoUHa0EN9oNz9d9XIolBksCI2opqhVBwkNNMoYHyt3-4iOTI26uT/exec';
const urlEstudiantes = 'https://script.google.com/macros/s/AKfycbyk1gUcU_cFSDbMz34WpEn1s81ctUIExmxzG062TZAx0KQhj5eOyQQVN2Rk8rLdMkicEA/exec';
const urlAppsScript = 'https://script.google.com/macros/s/AKfycbx2Hdz1rYL8GBn9PVG64sFOHC0wBfivmKFNwM4lmSWKzN6C7iKhTHRdxKMbwiowMnNx/exec';

localStorage.setItem('urlIncidencias', urlIncidencias);
localStorage.setItem('urlEstudiantes', urlEstudiantes);
localStorage.setItem('urlAppsScript', urlAppsScript);

let estudiantes = [];

// ==========================================
// ‚úÖ CARGA DE ESTUDIANTES (CORREGIDA)
// ==========================================
async function cargarEstudiantes() {
try {
const response = await fetch(urlEstudiantes);
const data = await response.json();

/* üîß AQU√ç ESTABA EL PROBLEMA */
if (Array.isArray(data)) {
estudiantes = data;
console.log(`‚úÖ ${estudiantes.length} estudiantes cargados`);
} else {
console.warn('Formato de estudiantes no v√°lido', data);
}

} catch (error) {
console.error('Error cargando estudiantes:', error);
}
}

// ==========================================
// AUTOCOMPLETADO (SIN CAMBIOS)
// ==========================================
const inputEstudiante = document.getElementById('nombreEstudiante');
const suggestionsDiv = document.getElementById('suggestions');

inputEstudiante.addEventListener('input', function () {
const texto = this.value.toLowerCase().trim();

if (texto.length < 2) {
suggestionsDiv.style.display = 'none';
return;
}

const coincidencias = estudiantes.filter(e =>
(e['Nombre Completo'] || '').toLowerCase().includes(texto)
).slice(0, 15);

if (!coincidencias.length) {
suggestionsDiv.style.display = 'none';
return;
}

suggestionsDiv.innerHTML = coincidencias.map((e, i) => `
<div class="suggestion-item" data-index="${i}">
<span class="suggestion-name">${e['Nombre Completo']}</span>
<span class="suggestion-course">(${e['Curso']})</span>
</div>
`).join('');

document.querySelectorAll('.suggestion-item').forEach((item, i) => {
item.addEventListener('click', () => {
inputEstudiante.value = coincidencias[i]['Nombre Completo'];
document.getElementById('cursoIncidencia').value = coincidencias[i]['Curso'];
suggestionsDiv.style.display = 'none';
});
});

suggestionsDiv.style.display = 'block';
});

document.addEventListener('click', e => {
if (!e.target.closest('.autocomplete-container')) {
suggestionsDiv.style.display = 'none';
}
});

// ==========================================
// INICIALIZACI√ìN
// ==========================================
window.addEventListener('DOMContentLoaded', () => {
const now = new Date();
now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
document.getElementById('fechaIncidencia').value = now.toISOString().slice(0, 16);

cargarEstudiantes();
console.log('‚úÖ Sistema cargado correctamente');
});
</script>
</body>
</html>
