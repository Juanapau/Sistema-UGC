<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Consulta - Sistema UGC</title>
<link rel="icon" type="image/png" href="./logo.png">
<style>
* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
min-height: 100vh;
padding: 20px;
position: relative;
overflow-x: hidden;
}

/* LOGO DE FONDO COMO MARCA DE AGUA */
body::before {
content: '';
position: fixed;
top: 50%;
left: 50%;
transform: translate(-50%, -50%);
width: 900px;
height: 900px;
background-image: url('./logo.png');
background-size: contain;
background-repeat: no-repeat;
background-position: center;
opacity: 0.08;
z-index: 0;
pointer-events: none;
filter: brightness(1.2);
}

.container {
position: relative;
z-index: 1;
max-width: 1400px;
margin: 0 auto;
}

header,
.dashboard,
.module-card,
.card {
position: relative;
z-index: 2;
}

header {
background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
color: white;
padding: 20px 30px;
border-radius: 15px;
margin-bottom: 30px;
box-shadow: 0 8px 32px rgba(0,0,0,0.3);
}

.header-top {
display: flex;
justify-content: space-between;
align-items: center;
gap: 20px;
flex-wrap: wrap;
}

.header-left {
display: flex;
align-items: center;
gap: 15px;
}

.header-left img {
width: 50px;
height: 50px;
}

.header-title h1 {
font-size: 1.5em;
margin-bottom: 3px;
}

.header-title p {
color: #4a9eff;
font-size: 0.85em;
}

.header-right {
display: flex;
align-items: center;
gap: 15px;
}

.user-bar {
background: white;
padding: 12px 20px;
border-radius: 10px;
margin-top: 15px;
display: flex;
justify-content: space-between;
align-items: center;
box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.user-info-bar {
display: flex;
align-items: center;
gap: 12px;
}

.user-avatar-bar {
width: 40px;
height: 40px;
background: #2a5298;
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
font-size: 1.2em;
}

.user-details-bar h3 {
color: #000000;
font-size: 0.95em;
margin-bottom: 2px;
}

.user-details-bar p {
color: #2a5298;
font-size: 0.75em;
font-weight: 600;
}

.btn-logout {
background: linear-gradient(135deg, #000000 0%, #333333 100%);
color: white;
border: none;
padding: 8px 20px;
border-radius: 8px;
cursor: pointer;
font-size: 0.9em;
font-weight: 600;
transition: all 0.3s;
}

.btn-logout:hover {
transform: translateY(-2px);
box-shadow: 0 5px 15px rgba(0,0,0,0.4);
}

.modules-grid {
display: grid;
grid-template-columns: repeat(3, 1fr);
gap: 20px;
}

/* Primera fila: 3 tarjetas */
.modules-grid .module-card:nth-child(1),
.modules-grid .module-card:nth-child(2),
.modules-grid .module-card:nth-child(3) {
grid-column: span 1;
}

/* Segunda fila: 2 tarjetas alineadas con las dos primeras de arriba */
.modules-grid .module-card:nth-child(4) {
grid-column: 1 / 2;
}

.modules-grid .module-card:nth-child(5) {
grid-column: 2 / 3;
}

.module-card {
background: white;
border-radius: 15px;
padding: 20px;
box-shadow: 0 8px 32px rgba(0,0,0,0.2);
cursor: pointer;
transition: all 0.3s ease;
border-top: 5px solid #2a5298;
}

.module-card:hover {
transform: translateY(-10px);
box-shadow: 0 12px 48px rgba(0,0,0,0.3);
border-top-color: #000000;
}

.module-header {
display: flex;
align-items: center;
gap: 15px;
margin-bottom: 15px;
}

.module-icon {
font-size: 2.5em;
color: #2a5298;
}

.module-info h3 {
color: #000000;
font-size: 1.3em;
margin-bottom: 5px;
}

.module-info p {
color: #666;
font-size: 0.85em;
}

.module-stats {
display: flex;
gap: 15px;
margin-top: 12px;
padding-top: 12px;
border-top: 2px solid #f0f0f0;
}

.stat-item {
flex: 1;
text-align: center;
}

.stat-item .number {
font-size: 1.8em;
font-weight: bold;
color: #2a5298;
display: block;
}

.stat-item .label {
font-size: 0.75em;
color: #666;
text-transform: uppercase;
margin-top: 5px;
}

.btn-view {
width: 100%;
padding: 10px 20px;
background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%);
color: white;
border: none;
border-radius: 8px;
font-size: 0.95em;
font-weight: 600;
cursor: pointer;
transition: all 0.3s;
margin-top: 12px;
}

.btn-view:hover {
transform: translateY(-2px);
box-shadow: 0 5px 15px rgba(42,82,152,0.4);
}

/* MODAL DE CONFIRMACI√ìN */
.modal-confirm {
display: none;
position: fixed;
z-index: 9999;
left: 0;
top: 0;
width: 100%;
height: 100%;
background-color: rgba(0,0,0,0.7);
align-items: center;
justify-content: center;
}

.modal-confirm-content {
background: white;
border-radius: 15px;
max-width: 450px;
width: 90%;
box-shadow: 0 12px 48px rgba(0,0,0,0.4);
animation: slideIn 0.3s ease;
overflow: hidden;
}

@keyframes slideIn {
from {
transform: translateY(-50px);
opacity: 0;
}
to {
transform: translateY(0);
opacity: 1;
}
}

.modal-confirm-header {
background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
color: white;
padding: 20px 25px;
text-align: center;
}

.modal-confirm-header h3 {
font-size: 1.3em;
}

.modal-confirm-body {
padding: 30px 25px;
text-align: center;
}

.modal-confirm-body p {
color: #666;
font-size: 1.05em;
line-height: 1.6;
}

.modal-confirm-buttons {
display: flex;
gap: 15px;
margin-top: 25px;
}

.btn-confirm {
flex: 1;
padding: 12px 30px;
border: none;
border-radius: 8px;
font-size: 1em;
font-weight: 600;
cursor: pointer;
transition: all 0.3s;
}

.btn-confirm-yes {
background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%);
color: white;
}

.btn-confirm-yes:hover {
transform: translateY(-2px);
box-shadow: 0 5px 15px rgba(42,82,152,0.4);
}

.btn-confirm-no {
background: linear-gradient(135deg, #000000 0%, #333333 100%);
color: white;
}

.btn-confirm-no:hover {
transform: translateY(-2px);
box-shadow: 0 5px 15px rgba(0,0,0,0.4);
}

@media (max-width: 768px) {
.header-top {
flex-direction: column;
}

.modules-grid {
grid-template-columns: 1fr;
}

.modules-grid .module-card:nth-child(1),
.modules-grid .module-card:nth-child(2),
.modules-grid .module-card:nth-child(3),
.modules-grid .module-card:nth-child(4),
.modules-grid .module-card:nth-child(5) {
grid-column: auto;
}
}
</style>
</head>
<body>

<div class="container">
<!-- HEADER -->
<header>
<div class="header-top">
<div class="header-left">
<img src="./logo.png" alt="Logo" onerror="this.style.display='none'">
<div class="header-title">
<h1>Sistema de Consulta</h1>
<p>Solo Lectura - PNSA</p>
</div>
</div>
</div>

<!-- BARRA DE USUARIO -->
<div class="user-bar">
<div class="user-info-bar">
<div class="user-avatar-bar">üë§</div>
<div class="user-details-bar">
<h3 id="userName">Usuario de Consulta</h3>
<p id="userCargo">üîç Acceso de solo lectura</p>
</div>
</div>
<button class="btn-logout" onclick="mostrarConfirmacionSalir()">
üö™ Salir
</button>
</div>
</header>

<!-- M√ìDULOS -->
<div class="modules-grid">
<!-- INCIDENCIAS -->
<div class="module-card" onclick="verModulo('incidencias')">
<div class="module-header">
<div class="module-icon">üìã</div>
<div class="module-info">
<h3>Incidencias</h3>
<p>Registro de conductas</p>
</div>
</div>
<div class="module-stats">
<div class="stat-item">
<span class="number" id="statIncidencias">---</span>
<span class="label">Registros</span>
</div>
<div class="stat-item">
<span class="number" id="statIncidenciasMes">---</span>
<span class="label">Este mes</span>
</div>
</div>
<button class="btn-view">üëÅÔ∏è Ver Registros</button>
</div>

<!-- TARDANZAS -->
<div class="module-card" onclick="verModulo('tardanzas')">
<div class="module-header">
<div class="module-icon">‚è∞</div>
<div class="module-info">
<h3>Tardanzas</h3>
<p>Control de llegadas tarde</p>
</div>
</div>
<div class="module-stats">
<div class="stat-item">
<span class="number" id="statTardanzas">---</span>
<span class="label">Total</span>
</div>
<div class="stat-item">
<span class="number" id="statTardanzasHoy">---</span>
<span class="label">Hoy</span>
</div>
</div>
<button class="btn-view">üëÅÔ∏è Ver Registros</button>
</div>

<!-- CONTACTOS -->
<div class="module-card" onclick="verModulo('contactos')">
<div class="module-header">
<div class="module-icon">üìû</div>
<div class="module-info">
<h3>Contactos</h3>
<p>Informaci√≥n de padres</p>
</div>
</div>
<div class="module-stats">
<div class="stat-item">
<span class="number" id="statContactos">---</span>
<span class="label">Registros</span>
</div>
<div class="stat-item">
<span class="number" id="statSinContactos">---</span>
<span class="label">Sin Contacto</span>
</div>
</div>
<button class="btn-view">üëÅÔ∏è Ver Contactos</button>
</div>

<!-- REUNIONES Y ACUERDOS -->
<div class="module-card" onclick="verModulo('reuniones')">
<div class="module-header">
<div class="module-icon">ü§ù</div>
<div class="module-info">
<h3>Reuniones y Acuerdos</h3>
<p>Con padres de familia</p>
</div>
</div>
<div class="module-stats">
<div class="stat-item">
<span class="number" id="statReuniones">---</span>
<span class="label">Total</span>
</div>
<div class="stat-item">
<span class="number" id="statReunionesMes">---</span>
<span class="label">Este Mes</span>
</div>
</div>
<button class="btn-view">üëÅÔ∏è Ver Reuniones</button>
</div>

<!-- ESTAD√çSTICAS -->
<div class="module-card" onclick="verModulo('estadisticas')">
<div class="module-header">
<div class="module-icon">üìä</div>
<div class="module-info">
<h3>Estad√≠sticas</h3>
<p>Estad√≠sticas generales</p>
</div>
</div>
<div class="module-stats">
<div class="stat-item">
<span class="number">üìà</span>
<span class="label">An√°lisis</span>
</div>
<div class="stat-item">
<span class="number">üìâ</span>
<span class="label">Tendencias</span>
</div>
</div>
<button class="btn-view">üëÅÔ∏è Ver Reportes</button>
</div>
</div>
</div>

<!-- MODAL DE CONFIRMACI√ìN -->
<div class="modal-confirm" id="modalConfirm">
<div class="modal-confirm-content">
<div class="modal-confirm-header">
<h3>‚ö†Ô∏è Confirmar Cierre de Sesi√≥n</h3>
</div>
<div class="modal-confirm-body">
<p>¬øEst√°s seguro de que deseas cerrar sesi√≥n?</p>
<div class="modal-confirm-buttons">
<button class="btn-confirm btn-confirm-yes" onclick="cerrarSesion()">
S√≠, Cerrar Sesi√≥n
</button>
<button class="btn-confirm btn-confirm-no" onclick="cerrarModal()">
Cancelar
</button>
</div>
</div>
</div>
</div>

<script>
// ==========================================
// VERIFICAR AUTENTICACI√ìN
// ==========================================

window.addEventListener('load', function() {
const usuarioData = localStorage.getItem('usuarioUGC');

if (!usuarioData) {
window.location.href = 'index.html';
return;
}

const usuario = JSON.parse(usuarioData);

if (usuario.rol !== 'consulta') {
if (usuario.rol === 'administrador') {
console.log('‚ÑπÔ∏è Administrador en vista de consulta');
} else {
window.location.href = 'index.html';
return;
}
}

document.getElementById('userName').textContent = usuario.nombre;
if (usuario.cargo) {
document.getElementById('userCargo').textContent = 'üíº ' + usuario.cargo;
}

console.log('‚úÖ Usuario autenticado:', usuario);

cargarEstadisticas();
});

// ==========================================
// CARGAR ESTAD√çSTICAS REALES
// ==========================================

// URLs de Google Sheets
const CONFIG_STATS = {
urlIncidencias: 'https://script.google.com/macros/s/AKfycbwnCHIHNum-8uCHLbuE5NvwJeVmVMF6hCLWOAQQRUOwsU5GK_vpkrxifDFlMat1tP-z/exec',
urlTardanzas: 'https://script.google.com/macros/s/AKfycbxI2JCRc-f0MdokDyepK_UOPf_gAbjYpCWzqe6ShqhRIP7uurohjBdswChKHaExsT2Riw/exec',
urlReuniones: 'https://script.google.com/macros/s/AKfycbxjky9LnAAqElohVjgLESUA2nh-ICXYWNDMGkVfGjwVEb1tc0HQAtg-sayrFMXH788aLA/exec',
urlContactos: 'https://script.google.com/macros/s/AKfycbxcnvwmyorCWze_CkDPEUtdHPpD0qPbGCtse4Ku16yxwhVo-8AjnXpKTudVi-0dVwOK/exec',
urlEstudiantes: 'https://script.google.com/macros/s/AKfycby-ceKgHZzTxQzcVcNiOWaN5aNDoqtIlihVcOZAp0_5hIVcv115GKHtfdjFPq43ttCEuA/exec'
};

async function cargarDatosDesdeGoogleSheets(url) {
try {
const response = await fetch(url);
if (!response.ok) throw new Error('Error en la respuesta');
return await response.json();
} catch (error) {
console.error('Error cargando datos:', error);
return [];
}
}

async function cargarEstadisticas() {
console.log('üìä ===== INICIANDO CARGA DE ESTAD√çSTICAS =====');
console.log('üìä URLs configuradas:');
console.log('  - Incidencias:', CONFIG_STATS.urlIncidencias);
console.log('  - Tardanzas:', CONFIG_STATS.urlTardanzas);

// Valores por defecto mientras carga
document.getElementById('statIncidencias').textContent = '...';
document.getElementById('statIncidenciasMes').textContent = '...';
document.getElementById('statTardanzas').textContent = '...';
document.getElementById('statTardanzasHoy').textContent = '...';
document.getElementById('statReuniones').textContent = '...';
document.getElementById('statReunionesMes').textContent = '...';
document.getElementById('statContactos').textContent = '...';
document.getElementById('statSinContactos').textContent = '...';

console.log('üìä Valores iniciales establecidos en "..."');

try {
// Cargar incidencias
console.log('üì• Cargando incidencias desde Google Sheets...');
const incidencias = await cargarDatosDesdeGoogleSheets(CONFIG_STATS.urlIncidencias);
console.log('üì• Incidencias recibidas:', incidencias.length, 'registros');

const totalIncidencias = incidencias.length;

// Calcular incidencias del mes actual
const mesActual = new Date().getMonth();
const a√±oActual = new Date().getFullYear();
console.log('üìÖ Mes actual:', mesActual, 'A√±o:', a√±oActual);

const incidenciasMes = incidencias.filter(inc => {
try {
const fecha = new Date(inc['Fecha y Hora']);
return fecha.getMonth() === mesActual && fecha.getFullYear() === a√±oActual;
} catch {
return false;
}
}).length;

console.log('üìä Total incidencias:', totalIncidencias);
console.log('üìä Incidencias del mes:', incidenciasMes);

// Actualizar incidencias
console.log('üîÑ Actualizando elementos HTML...');
document.getElementById('statIncidencias').textContent = totalIncidencias;
document.getElementById('statIncidenciasMes').textContent = incidenciasMes;

console.log(`‚úÖ Incidencias actualizadas: ${totalIncidencias} (Mes: ${incidenciasMes})`);

// Cargar tardanzas
console.log('üì• Cargando tardanzas desde Google Sheets...');
const tardanzas = await cargarDatosDesdeGoogleSheets(CONFIG_STATS.urlTardanzas);
console.log('üì• Tardanzas recibidas:', tardanzas.length, 'registros');

const totalTardanzas = tardanzas.length;

// Calcular tardanzas de hoy
const hoy = new Date().toISOString().split('T')[0];
console.log('üìÖ Fecha de hoy:', hoy);

const tardanzasHoy = tardanzas.filter(tard => {
try {
const fecha = new Date(tard.fecha || tard.Fecha);
return fecha.toISOString().split('T')[0] === hoy;
} catch {
return false;
}
}).length;

console.log('üìä Total tardanzas:', totalTardanzas);
console.log('üìä Tardanzas de hoy:', tardanzasHoy);

// Actualizar tardanzas
document.getElementById('statTardanzas').textContent = totalTardanzas;
document.getElementById('statTardanzasHoy').textContent = tardanzasHoy;

console.log(`‚úÖ Tardanzas actualizadas: ${totalTardanzas} (Hoy: ${tardanzasHoy})`);

// Cargar reuniones
console.log('üì• Cargando reuniones desde Google Sheets...');
const reuniones = await cargarDatosDesdeGoogleSheets(CONFIG_STATS.urlReuniones);
console.log('üì• Reuniones recibidas:', reuniones.length, 'registros');

const totalReuniones = reuniones.length;

const reunionesMes = reuniones.filter(reun => {
try {
const fecha = new Date(reun['Fecha y Hora']);
return fecha.getMonth() === mesActual && fecha.getFullYear() === a√±oActual;
} catch {
return false;
}
}).length;

console.log('üìä Total reuniones:', totalReuniones);
console.log('üìä Reuniones del mes:', reunionesMes);

// Actualizar reuniones
document.getElementById('statReuniones').textContent = totalReuniones;
document.getElementById('statReunionesMes').textContent = reunionesMes;

console.log(`‚úÖ Reuniones actualizadas: ${totalReuniones} (Mes: ${reunionesMes})`);

// Cargar contactos
console.log('üì• Cargando contactos desde Google Sheets...');
const contactos = await cargarDatosDesdeGoogleSheets(CONFIG_STATS.urlContactos);
console.log('üì• Contactos recibidos:', contactos.length, 'registros');

// Cargar estudiantes para calcular sin contactos
console.log('üì• Cargando estudiantes desde Google Sheets...');
const estudiantes = await cargarDatosDesdeGoogleSheets(CONFIG_STATS.urlEstudiantes);
console.log('üì• Estudiantes recibidos:', estudiantes.length, 'registros');

const totalContactos = contactos.length;

// Calcular estudiantes sin contactos
const normalizarNombre = (nombre) => (nombre || '').toLowerCase().trim().replace(/\s+/g, ' ');
const estudiantesConContactos = new Set(
contactos.map(c => {
const nombre = c['Nombre Estudiante'] || c['Mombre Estudiante'] || c.estudiante || '';
return normalizarNombre(nombre);
}).filter(n => n !== '')
);
const sinContactos = estudiantes.filter(est => {
const nombre = est['Nombre Completo'] || est.nombre || est.Nombre || '';
const nombreNormalizado = normalizarNombre(nombre);
return nombreNormalizado !== '' && !estudiantesConContactos.has(nombreNormalizado);
}).length;

console.log('üìä Total contactos:', totalContactos);
console.log('üìä Estudiantes sin contactos:', sinContactos);

// Actualizar contactos
document.getElementById('statContactos').textContent = totalContactos;
document.getElementById('statSinContactos').textContent = sinContactos;

console.log(`‚úÖ Contactos actualizados: ${totalContactos} (Sin contacto: ${sinContactos})`);
console.log('üìä ===== ESTAD√çSTICAS REALES CARGADAS =====');

} catch (error) {
console.error('‚ùå ===== ERROR CARGANDO ESTAD√çSTICAS =====');
console.error('‚ùå Error completo:', error);
console.error('‚ùå Tipo:', error.name);
console.error('‚ùå Mensaje:', error.message);

// Mostrar 0 en caso de error
document.getElementById('statIncidencias').textContent = '0';
document.getElementById('statIncidenciasMes').textContent = '0';
document.getElementById('statTardanzas').textContent = '0';
document.getElementById('statTardanzasHoy').textContent = '0';
document.getElementById('statReuniones').textContent = '0';
document.getElementById('statReunionesMes').textContent = '0';
document.getElementById('statContactos').textContent = '0';
document.getElementById('statSinContactos').textContent = '0';
}
}

// ==========================================
// VER M√ìDULO
// ==========================================

function verModulo(modulo) {
console.log('üëÅÔ∏è Abriendo m√≥dulo:', modulo);

const paginas = {
'incidencias': 'incidencias-consulta.html',
'tardanzas': 'tardanzas-consulta.html',
'contactos': 'contactos-consulta.html',
'estadisticas': 'estadisticas-consulta.html',
'reuniones': 'reuniones-consulta.html'
};

if (paginas[modulo]) {
window.location.href = paginas[modulo];
} else {
alert(`üìä M√≥dulo de ${modulo}\n\nüîí Vista de solo lectura activada.`);
}
}

// ==========================================
// MODAL DE CONFIRMACI√ìN
// ==========================================

function mostrarConfirmacionSalir() {
document.getElementById('modalConfirm').style.display = 'flex';
}

function cerrarModal() {
document.getElementById('modalConfirm').style.display = 'none';
}

// ==========================================
// CERRAR SESI√ìN
// ==========================================

function cerrarSesion() {
localStorage.removeItem('usuarioUGC');
console.log('üëã Sesi√≥n cerrada');
window.location.href = 'index.html';
}

// Cerrar modal al hacer clic fuera
window.onclick = function(event) {
const modal = document.getElementById('modalConfirm');
if (event.target == modal) {
cerrarModal();
}
}

console.log('üìä Sistema de consulta cargado');
</script>

</body>
</html>
