<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Estad√≠sticas - Consulta</title>
<link rel="icon" type="image/png" href="./logo.png">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
min-height: 100vh;
padding: 20px;
position: relative;
overflow-x: hidden;
}

/* LOGO DE FONDO COMO MARCA DE AGUA */
body::before {
content: '';
position: fixed;
top: 50%;
left: 50%;
transform: translate(-50%, -50%);
width: 900px;
height: 900px;
background-image: url('./logo.png');
background-size: contain;
background-repeat: no-repeat;
background-position: center;
opacity: 0.08;
z-index: 0;
pointer-events: none;
filter: brightness(1.2);
}

.container { 
max-width: 1400px; 
margin: 0 auto;
position: relative;
z-index: 1;
}

header,
.content-card,
.stat-card {
position: relative;
z-index: 2;
}

header {
background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
color: white;
padding: 20px 30px;
border-radius: 15px;
margin-bottom: 25px;
box-shadow: 0 8px 32px rgba(0,0,0,0.3);
display: flex;
justify-content: space-between;
align-items: center;
flex-wrap: wrap;
gap: 15px;
}

.header-left { display: flex; align-items: center; gap: 15px; }
.header-left img { width: 50px; height: 50px; }
.header-title h1 { font-size: 1.6em; margin-bottom: 3px; }
.header-title p { color: #4a9eff; font-size: 0.85em; }

.btn-back {
background: linear-gradient(135deg, #000000 0%, #333333 100%);
color: white;
border: none;
padding: 10px 20px;
border-radius: 8px;
cursor: pointer;
font-size: 0.9em;
font-weight: 600;
transition: all 0.3s;
text-decoration: none;
display: inline-block;
}

.btn-back:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.3); }

.content-card {
background: white;
border-radius: 15px;
padding: 30px;
box-shadow: 0 8px 32px rgba(0,0,0,0.2);
}

.alert-readonly {
background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
border: 2px solid #fbbf24;
border-radius: 12px;
padding: 15px 20px;
margin-bottom: 25px;
display: flex;
align-items: center;
gap: 12px;
}

.alert-readonly .icon { font-size: 1.8em; }
.alert-readonly p { color: #92400e; font-size: 0.9em; margin: 0; }

.stats-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
gap: 20px;
margin-bottom: 30px;
}

.stat-card {
background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
padding: 25px;
border-radius: 12px;
text-align: center;
border-top: 4px solid #2a5298;
box-shadow: 0 4px 12px rgba(0,0,0,0.1);
transition: all 0.3s;
}

.stat-card:hover {
transform: translateY(-5px);
box-shadow: 0 8px 20px rgba(0,0,0,0.15);
}

.stat-card .icon {
font-size: 3em;
margin-bottom: 10px;
}

.stat-card .number {
font-size: 2.5em;
font-weight: bold;
color: #2a5298;
display: block;
margin-bottom: 5px;
}

.stat-card .label {
font-size: 0.95em;
color: #666;
font-weight: 600;
}

/* Tarjetas con detalles */
.stat-card-detailed {
padding-bottom: 20px;
}

.stat-details {
margin-top: 15px;
padding-top: 15px;
border-top: 1px solid #e0e0e0;
}

.stat-detail-item {
display: flex;
justify-content: center;
align-items: center;
gap: 8px;
margin-bottom: 12px;
font-size: 0.9em;
}

.detail-label {
color: #666;
font-weight: 500;
}

.detail-value {
color: #2a5298;
font-weight: 700;
font-size: 1.1em;
}

.stat-breakdown {
display: flex;
flex-direction: row;
justify-content: center;
gap: 15px;
margin-top: 10px;
flex-wrap: wrap;
}

.breakdown-item {
display: flex;
align-items: center;
gap: 5px;
font-size: 0.85em;
}

.breakdown-dot {
width: 10px;
height: 10px;
border-radius: 50%;
display: inline-block;
}

.breakdown-dot.leve {
background: #28a745;
}

.breakdown-dot.grave {
background: #ffc107;
}

.breakdown-dot.muy-grave {
background: #dc3545;
}

.breakdown-text {
color: #555;
}

.breakdown-text strong {
color: #333;
font-weight: 700;
}

.info-message {
text-align: center;
padding: 60px 20px;
color: #666;
}

.info-message-icon {
font-size: 5em;
margin-bottom: 20px;
opacity: 0.5;
}

.info-message h3 {
color: #333;
margin-bottom: 10px;
font-size: 1.5em;
}

.info-message p {
font-size: 1.05em;
line-height: 1.6;
max-width: 600px;
margin: 0 auto;
}

@media (max-width: 768px) {
header { flex-direction: column; text-align: center; }
.stats-grid { grid-template-columns: 1fr; }
}
</style>
</head>
<body>

<div class="container">
<header>
<div class="header-left">
<img src="./logo.png" alt="Logo" onerror="this.style.display='none'">
<div class="header-title">
<h1>Estad√≠sticas Generales</h1>
<p>Solo Lectura - CENSA</p>
</div>
</div>
<a href="consulta.html" class="btn-back">‚Üê Volver al Dashboard</a>
</header>

<div class="content-card">

<div class="stats-grid">
<!-- TARJETA 1: TOTAL INCIDENCIAS CON DETALLES -->
<div class="stat-card stat-card-detailed">
<div class="icon">üìã</div>
<span class="number" id="totalIncidencias">0</span>
<span class="label">Total Incidencias</span>
<div class="stat-details">
<div class="stat-detail-item">
<span class="detail-label">Este mes:</span>
<span class="detail-value" id="incidenciasMes">0</span>
</div>
<div class="stat-breakdown">
<div class="breakdown-item">
<span class="breakdown-dot leve"></span>
<span class="breakdown-text">Leves: <strong id="incidenciasLeves">0</strong></span>
</div>
<div class="breakdown-item">
<span class="breakdown-dot grave"></span>
<span class="breakdown-text">Graves: <strong id="incidenciasGraves">0</strong></span>
</div>
<div class="breakdown-item">
<span class="breakdown-dot muy-grave"></span>
<span class="breakdown-text">Muy Graves: <strong id="incidenciasMuyGraves">0</strong></span>
</div>
</div>
</div>
</div>

<!-- TARJETA 2: TOTAL TARDANZAS CON ESTE MES -->
<div class="stat-card stat-card-detailed">
<div class="icon">‚è∞</div>
<span class="number" id="totalTardanzas">0</span>
<span class="label">Total Tardanzas</span>
<div class="stat-details">
<div class="stat-detail-item">
<span class="detail-label">Este mes:</span>
<span class="detail-value" id="tardanzasMes">0</span>
</div>
</div>
</div>

<!-- TARJETA 3: ESTUDIANTES REGISTRADOS -->
<div class="stat-card">
<div class="icon">üë•</div>
<span class="number" id="totalEstudiantes">0</span>
<span class="label">Estudiantes Registrados</span>
</div>

<!-- TARJETA 4: CONTACTOS REGISTRADOS -->
<div class="stat-card">
<div class="icon">üìû</div>
<span class="number" id="totalContactos">0</span>
<span class="label">Contactos Registrados</span>
</div>
</div>

</div>
</div>

<script src="./auth-guard.js"></script>
<script>
let CONFIG = { 
urlIncidencias: 'https://script.google.com/macros/s/AKfycbwnCHIHNum-8uCHLbuE5NvwJeVmVMF6hCLWOAQQRUOwsU5GK_vpkrxifDFlMat1tP-z/exec',
urlTardanzas: 'https://script.google.com/macros/s/AKfycbxI2JCRc-f0MdokDyepK_UOPf_gAbjYpCWzqe6ShqhRIP7uurohjBdswChKHaExsT2Riw/exec',
urlEstudiantes: 'https://script.google.com/macros/s/AKfycby-ceKgHZzTxQzcVcNiOWaN5aNDoqtIlihVcOZAp0_5hIVcv115GKHtfdjFPq43ttCEuA/exec',
urlContactos: 'https://script.google.com/macros/s/AKfycbxcnvwmyorCWze_CkDPEUtdHPpD0qPbGCtse4Ku16yxwhVo-8AjnXpKTudVi-0dVwOK/exec'
};

window.addEventListener('load', function() {
const configGuardada = localStorage.getItem('censaConfig');
if (configGuardada) {
const configTemp = JSON.parse(configGuardada);
if (configTemp.urlIncidencias) CONFIG.urlIncidencias = configTemp.urlIncidencias;
if (configTemp.urlTardanzas) CONFIG.urlTardanzas = configTemp.urlTardanzas;
if (configTemp.urlEstudiantes) CONFIG.urlEstudiantes = configTemp.urlEstudiantes;
console.log('‚úÖ Configuraci√≥n actualizada desde localStorage');
}
console.log('üìä URLs:', CONFIG);

cargarEstadisticas();
});

async function cargarDatosDesdeGoogleSheets(url) {
try {
const response = await fetch(url);
if (!response.ok) throw new Error('Error en la respuesta');
return await response.json();
} catch (error) {
console.error('Error:', error);
return [];
}
}

async function cargarEstadisticas() {
try {
// Cargar incidencias
let incidencias = [];
if (CONFIG.urlIncidencias) {
incidencias = await cargarDatosDesdeGoogleSheets(CONFIG.urlIncidencias);
}

// Cargar tardanzas
let tardanzas = [];
if (CONFIG.urlTardanzas) {
tardanzas = await cargarDatosDesdeGoogleSheets(CONFIG.urlTardanzas);
}

// Cargar estudiantes
let estudiantes = [];
if (CONFIG.urlEstudiantes) {
estudiantes = await cargarDatosDesdeGoogleSheets(CONFIG.urlEstudiantes);
}

// Cargar contactos
let contactos = [];
if (CONFIG.urlContactos) {
contactos = await cargarDatosDesdeGoogleSheets(CONFIG.urlContactos);
}

// Calcular estad√≠sticas
const mesActual = new Date().getMonth();
const a√±oActual = new Date().getFullYear();

const incidenciasMes = incidencias.filter(inc => {
try {
const fecha = new Date(inc['Fecha y Hora']);
return fecha.getMonth() === mesActual && fecha.getFullYear() === a√±oActual;
} catch {
return false;
}
});

// Calcular incidencias por tipo
const incidenciasLeves = incidencias.filter(inc => {
const tipo = (inc['Tipo de falta'] || '').toLowerCase();
return tipo.includes('leve') && !tipo.includes('grave');
}).length;

const incidenciasGraves = incidencias.filter(inc => {
const tipo = (inc['Tipo de falta'] || '').toLowerCase();
return tipo === 'grave' || tipo.includes('falta grave');
}).length;

const incidenciasMuyGraves = incidencias.filter(inc => {
const tipo = (inc['Tipo de falta'] || '').toLowerCase();
return tipo.includes('muy grave');
}).length;

const tardanzasMes = tardanzas.filter(tard => {
try {
const fecha = new Date(tard['Fecha']);
return fecha.getMonth() === mesActual && fecha.getFullYear() === a√±oActual;
} catch {
return false;
}
});

// Actualizar UI
document.getElementById('totalIncidencias').textContent = incidencias.length;
document.getElementById('incidenciasMes').textContent = incidenciasMes.length;
document.getElementById('incidenciasLeves').textContent = incidenciasLeves;
document.getElementById('incidenciasGraves').textContent = incidenciasGraves;
document.getElementById('incidenciasMuyGraves').textContent = incidenciasMuyGraves;

document.getElementById('totalTardanzas').textContent = tardanzas.length;
document.getElementById('tardanzasMes').textContent = tardanzasMes.length;

document.getElementById('totalEstudiantes').textContent = estudiantes.length;
document.getElementById('totalContactos').textContent = contactos.length;

console.log('‚úÖ Estad√≠sticas cargadas');
console.log(`üìä Incidencias: ${incidencias.length} (Mes: ${incidenciasMes.length})`);
console.log(`üìä Por tipo: Leves=${incidenciasLeves}, Graves=${incidenciasGraves}, Muy Graves=${incidenciasMuyGraves}`);
console.log(`üìä Tardanzas: ${tardanzas.length} (Mes: ${tardanzasMes.length})`);
console.log(`üìä Estudiantes: ${estudiantes.length}, Contactos: ${contactos.length}`);
} catch (error) {
console.error('Error cargando estad√≠sticas:', error);
}
}

console.log('üìä M√≥dulo de estad√≠sticas (consulta) cargado');
</script>

</body>
</html>
